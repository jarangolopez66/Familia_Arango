<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Árbol genealógico — Familia Arango</title>

  <style>
    :root{
      --bg:#f6efe3;
      --card:#fff7ea;
      --card2:#fbf1df;
      --text:#151515;
      --muted:#6b5f4a;
      --gold:#c6a24a;
      --gold2:#e2c77c;
      --line:#dcc9a5;
      --shadow:0 10px 25px rgba(0,0,0,.12);
      --radius:18px;

      --btn-bg:#151515;
      --btn-text:#f6efe3;
      --btn-border:rgba(0,0,0,.18);

      --danger:#b6463f;
      --ok:#2f8f6b;

      --treeLine: rgba(0,0,0,.10);

      /* ✅ ancho de columna para que quepan parejas */
      --colW: 240px;

      /* ✅ se setea por JS */
      --headerH: 72px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      background:
        radial-gradient(900px 500px at 20% 10%, rgba(198,162,74,.18), transparent 60%),
        radial-gradient(800px 500px at 85% 15%, rgba(0,0,0,.08), transparent 60%),
        var(--bg);
      color:var(--text);
    }

    header{
      position:sticky; top:0; z-index:50;
      background: rgba(246,239,227,.88);
      backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(0,0,0,.08);
    }

    .wrap{max-width:1200px; margin:0 auto; padding:18px 16px;}
    h1{
      margin:0;
      font-size:22px;
      letter-spacing:.2px;
      display:flex;
      gap:10px;
      align-items:baseline;
      flex-wrap:wrap;
    }
    .brand{color:var(--gold); font-weight:900;}
    .sub{
      margin-top:8px;
      color:var(--muted);
      font-size:13px;
      line-height:1.4;
    }

    .toolbar{
      margin-top:14px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }

    .btn{
      cursor:pointer;
      border:1px solid var(--btn-border);
      background: var(--btn-bg);
      color: var(--btn-text);
      padding:8px 10px;
      border-radius: 12px;
      transition: transform .05s ease, opacity .15s ease;
      font-weight:900;
      font-size:12px;
      box-shadow: 0 6px 16px rgba(0,0,0,.10);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      user-select:none;
      text-decoration:none;
      white-space:nowrap;
    }
    .btn:hover{opacity:.92}
    .btn:active{transform: translateY(1px);}
    .btn-primary{
      background: linear-gradient(180deg, var(--gold2), var(--gold));
      color:#201a10;
      border-color: rgba(0,0,0,.14);
    }
    .btn-danger{
      background: rgba(182,70,63,.14);
      color:#4a1411;
      border-color: rgba(182,70,63,.30);
      box-shadow:none;
    }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.55);
      color: var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .dot{width:9px; height:9px; border-radius:50%;}
    .dot.ok{background: var(--ok); box-shadow: 0 0 0 4px rgba(47,143,107,.12);}
    .dot.bad{background: var(--danger); box-shadow: 0 0 0 4px rgba(182,70,63,.12);}

    /* Buscador */
    .searchWrap{
      display:flex;
      gap:8px;
      align-items:center;
      flex: 1 1 auto;
      justify-content:flex-end;
      min-width: 280px;
      position: relative;
    }
    .searchInput{
      width: min(420px, 70vw);
      padding:9px 10px;
      border-radius: 12px;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.65);
      outline:none;
      font-size:12px;
    }
    .searchInput:focus{
      border-color: rgba(198,162,74,.55);
      box-shadow: 0 0 0 4px rgba(198,162,74,.16);
    }
    .searchResults{
      position:absolute;
      top: 42px;
      right: 0;
      width: min(520px, 92vw);
      max-height: 320px;
      overflow:auto;
      background: rgba(246,239,227,.98);
      border:1px solid rgba(0,0,0,.12);
      border-radius: 14px;
      box-shadow: 0 14px 40px rgba(0,0,0,.18);
      padding: 6px;
      display:none;
      z-index: 60;
    }
    .searchResults.show{ display:block; }
    .srItem{
      display:flex;
      gap:10px;
      align-items:center;
      padding:8px 10px;
      border-radius: 12px;
      cursor:pointer;
      user-select:none;
    }
    .srItem:hover{ background: rgba(0,0,0,.05); }
    .srThumb{
      width:28px; height:28px;
      border-radius: 10px;
      overflow:hidden;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(0,0,0,.04);
      flex:0 0 auto;
    }
    .srThumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .srText{ display:flex; flex-direction:column; gap:2px; }
    .srName{ font-weight:900; font-size:12px; }
    .srMeta{ font-size:11px; color: var(--muted); }

    /* Zoom controls */
    .zoomWrap{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:flex-end;
      flex: 0 0 auto;
    }
    .zoomBtn{ padding:8px 10px; min-width: 40px; }
    .zoomPct{ min-width: 76px; justify-content:center; }

    main{padding:18px 16px 34px;}
    .container{max-width:1200px; margin:0 auto;}

    /* Portada */
    .cover{
      background: linear-gradient(180deg, var(--card), var(--card2));
      border:1px solid rgba(0,0,0,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      margin-bottom: 18px;
    }

    /* ✅ Sticky SOLO la franja de imagen+texto */
    .cover-top{
      display:grid;
      grid-template-columns: 1.6fr 1fr;
      gap: 14px;
      padding: 14px;
      align-items: stretch;

      position: sticky;
      top: var(--headerH);
      z-index: 20;
      background: linear-gradient(180deg, var(--card), var(--card2));
      border-bottom: 1px solid rgba(0,0,0,.08);
    }

    .cover-imgwrap{
      border-radius: 16px;
      overflow:hidden;
      border:1px solid rgba(0,0,0,.10);
      background: rgba(0,0,0,.04);
      min-height: 230px;
    }
    .cover-imgwrap img{width:100%; height:100%; object-fit:cover; display:block;}
    .cover-side{
      display:flex; flex-direction:column; gap:10px;
      justify-content:space-between;
    }
    .cover-side h2{margin:0; font-size:16px; letter-spacing:.2px;}
    .cover-side p{margin:6px 0 0 0; color:var(--muted); font-size:12px; line-height:1.35;}
    .cover-actions{display:flex; flex-wrap:wrap; gap:10px; margin-top:10px;}

    .strip{
      padding: 0 14px 14px 14px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    .sib{
      display:flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius: 999px;
      border:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.55);
      cursor:pointer;
      user-select:none;
    }
    .sib img{
      width:34px; height:34px;
      border-radius: 999px;
      object-fit: cover;
      border:1px solid rgba(0,0,0,.12);
      display:block;
    }
    .sib span{
      font-size:12px;
      color: var(--text);
      max-width: 150px;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* Árbol (zoomable) */
    .divider{height:1px; background: rgba(0,0,0,.10); margin: 16px 0;}
    .gen{display:flex; justify-content:center; gap:18px; flex-wrap:wrap; position:relative;}

    /* Padres como PAREJA (unidos) */
    .couple{justify-content:center; align-items:stretch;}
    .coupleWrap{
      display:flex;
      gap:18px;
      align-items:stretch;
      justify-content:center;
      position:relative;
      padding-bottom: 10px;
      width:100%;
      flex-wrap:wrap;
    }
    .coupleWrap::after{
      content:"";
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      bottom:-6px;
      width: min(520px, 84%);
      height: 3px;
      background: rgba(198,162,74,.55);
      border-radius: 99px;
    }

    /* ✅ Zoom viewport */
    .treeViewport{
      border:1px solid rgba(0,0,0,.10);
      border-radius: 16px;
      background: rgba(255,255,255,.35);
      box-shadow: 0 10px 22px rgba(0,0,0,.08);
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      height: min(74vh, 760px);
      padding: 10px;
      cursor: grab;
    }
    .treeViewport:active{ cursor: grabbing; }

    .treeSpace{
      position: relative;
      width: 100px; height: 100px; /* se actualiza por JS */
    }
    .treeScaler{
      position: absolute;
      top: 0; left: 0;
      transform-origin: 0 0;
    }

    /* LAYOUT columnas */
    .treeGrid{
      display:grid;
      grid-template-columns: repeat(11, var(--colW));
      gap: 14px;
      align-items:start;
      justify-content:center;
      padding: 6px 4px 2px;
      min-width: calc(11 * var(--colW) + 10 * 14px);
    }
    .treeGrid.moreCols{
      grid-auto-flow: column;
      grid-auto-columns: var(--colW);
      grid-template-columns: repeat(11, var(--colW));
    }

    .subtree{
      position:relative;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 10px;
      padding: 6px 4px 2px;
    }

    .node{
      position:relative;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 6px;
      cursor:pointer;
      user-select:none;
      max-width: 220px;
    }

    .circle{
      border-radius: 999px;
      overflow:hidden;
      background: rgba(0,0,0,.04);
      border: 2px solid rgba(0,0,0,.12);
      box-shadow: 0 8px 18px rgba(0,0,0,.10);
    }
    .circle img{width:100%; height:100%; object-fit:cover; display:block;}

    .labelName{
      font-size: 12px;
      font-weight: 900;
      text-align:center;
      max-width: 200px;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .labelYears{
      font-size: 11px;
      color: var(--muted);
      margin-top: -4px;
      text-align:center;
    }

    /* Marco por nivel */
    .lvl-parent .circle{
      width:110px; height:130px;
      border-width: 4px;
      border-color: rgba(0,0,0,.78);
      box-shadow: 0 0 0 6px rgba(198,162,74,.14), 0 10px 22px rgba(0,0,0,.10);
    }
    .lvl-original .circle{
      width:100px; height:110px;
      border-width: 4px;
      border-color: rgba(198,162,74,.60);
      box-shadow: 0 0 0 5px rgba(198,162,74,.10), 0 9px 18px rgba(0,0,0,.10);
    }
    .lvl-1 .circle{
      width:80px; height:80px;
      border-width: 4px;
      border-color: rgba(79,134,170,.90);
      box-shadow: 0 0 0 3px rgba(79,134,170,.16);
    }
    /* Bisnietos: cuadritos */
    .lvl-2 .circle{
      width:64px; height:64px;
      border-width: 3px;
      border-color: rgba(179,109,76,.90);
      box-shadow: 0 0 0 3px rgba(179,109,76,.14);
      opacity:.98;
      border-radius: 14px;
    }
    .lvl-3 .circle{
      width:52px; height:52px;
      border-width: 2px;
      border-color: rgba(207,225,246,.95);
      box-shadow: 0 0 0 3px rgba(207,225,246,.16);
      opacity:.96;
    }

    /* ✅ PAREJA: MISMO marco, pero BORDE PUNTEADO (SIN cuadro extra) */
    .node.spouseNode .circle{
      border-style: dashed;   /* <-- esto es lo único “punteado” */
    }

    /* unidad persona + pareja en la misma línea */
    .personUnit{
      display:flex;
      align-items:flex-start;
      justify-content:center;
      gap: 10px;
      flex-wrap: nowrap;
    }

    /* Conectores */
    .childrenGroup{
      position:relative;
      width: 100%;
      padding-top: 10px;
    }
    .childrenGroup::before{
      content:"";
      position:absolute;
      top: 0px;
      left: 12px;
      right: 12px;
      height:2px;
      background: var(--treeLine);
      border-radius: 99px;
    }
    .childrenGroup::after{
      content:"";
      position:absolute;
      top: -12px;
      left: 50%;
      width: 2px;
      height: 12px;
      background: var(--treeLine);
      transform: translateX(-50%);
      border-radius: 99px;
    }

    .childrenRow{
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
      justify-content:center;
      align-items:flex-start;
      margin-top: 8px;
    }

    .childWrap{
      position:relative;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 8px;
      padding-top: 10px;
    }
    .childWrap::before{
      content:"";
      position:absolute;
      top: 0px;
      left: 50%;
      width:2px;
      height:10px;
      background: var(--treeLine);
      transform: translateX(-50%);
      border-radius: 99px;
    }

    /* flash al buscar */
    .flash{
      outline: 4px solid rgba(198,162,74,.60);
      outline-offset: 4px;
      border-radius: 16px;
    }

    @media (max-width: 860px){
      .cover-top{grid-template-columns: 1fr;}
      .cover-imgwrap{min-height: 210px;}
      .searchWrap{ justify-content:flex-start; width:100%; }
      .searchInput{ width:100%; }
      :root{ --colW: 220px; }
      .treeViewport{ height: min(70vh, 720px); }
    }
    @media (max-width: 560px){
      :root{ --colW: 210px; }
      .lvl-parent .circle{ width:106px; height:106px; }
      .lvl-original .circle{ width:92px; height:92px; }
      .lvl-1 .circle{ width:62px; height:62px; }
      .lvl-2 .circle{ width:54px; height:54px; }
      .lvl-3 .circle{ width:46px; height:46px; }
    }

    /* =========================
       MODAL EDITOR
       ========================= */
    .modal{
      position:fixed; inset:0;
      background: rgba(0,0,0,.45);
      display:none;
      z-index: 9999;
      padding: 18px;
    }
    .modal.show{display:flex;}
    .modalPanel{
      margin:auto;
      width: min(860px, 100%);
      max-height: min(92vh, 900px);
      overflow:auto;
      background: rgba(246,239,227,.98);
      border:1px solid rgba(0,0,0,.12);
      border-radius: 18px;
      box-shadow: 0 18px 55px rgba(0,0,0,.25);
      padding: 14px;
    }
    .modalHead{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
    }
    .modalHead b{font-size:14px;}
    .modalClose{
      background: rgba(0,0,0,.06);
      border:1px solid rgba(0,0,0,.12);
      color: var(--text);
      box-shadow:none;
    }

    .person{
      width: 360px; max-width: calc(100vw - 32px);
      background: linear-gradient(180deg, var(--card), var(--card2));
      border: 1px solid rgba(0,0,0,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      position:relative;
      margin: 0 auto;
    }
    .person.parent-card{
      background: linear-gradient(180deg, #fff2d9, #f4e3bf);
      border-color: rgba(198,162,74,.55);
    }

    .role{
      font-size:12px;
      color: var(--muted);
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:10px;
    }
    .role b{color: var(--text); font-size:12px; letter-spacing:.2px;}

    .row{display:flex; gap:12px; align-items:center;}

    .avatar{
      width:98px; height:98px;
      border-radius:18px;
      border: 1px solid rgba(0,0,0,.12);
      overflow:hidden;
      background: rgba(0,0,0,.04);
      flex: 0 0 auto;
      cursor:pointer;
      user-select:none;
    }
    .avatar img{width:100%; height:100%; object-fit:cover; display:block;}

    .photo-actions{
      display:flex;
      flex-direction:column;
      gap:8px;
      flex: 1 1 auto;
    }

    .smallbtn{
      padding:7px 9px;
      border-radius: 12px;
      font-size:12px;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.55);
      color: var(--text);
      box-shadow:none;
      font-weight:900;
      cursor:pointer;
      user-select:none;
      text-align:center;
    }
    .smallbtn:hover{opacity:.92}
    .smallbtn.addkid{background: rgba(198,162,74,.20); border-color: rgba(198,162,74,.35);}
    .smallbtn.remove{background: rgba(182,70,63,.12); border-color: rgba(182,70,63,.28); color:#4a1411;}
    .smallbtn.addsp{background: rgba(79,134,170,.16); border-color: rgba(79,134,170,.28);}

    .fields{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    label{display:flex; flex-direction:column; gap:6px; font-size:12px; color: var(--muted);}
    input[type="text"], input[type="date"]{
      width:100%;
      padding:10px 10px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.65);
      color: var(--text);
      outline:none;
    }
    input[type="text"]::placeholder{color: rgba(107,95,74,.65);}
    input[type="text"]:focus, input[type="date"]:focus{
      border-color: rgba(198,162,74,.55);
      box-shadow: 0 0 0 4px rgba(198,162,74,.16);
    }

    .spouseBlock{
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px dashed rgba(0,0,0,.18);
    }
    .spouseHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
      color: var(--muted);
      font-size: 12px;
    }
    .spouseHead b{ color: var(--text); }
    .spouseCard{
      border: 1px solid rgba(0,0,0,.10);
      border-radius: 14px;
      padding: 10px;
      background: rgba(255,255,255,.40);
    }
    .spouseRow{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .spouseAvatar{
      width:72px; height:72px;
      border-radius: 14px;
      border: 1px dashed rgba(0,0,0,.22);
      overflow:hidden;
      background: rgba(0,0,0,.04);
      cursor:pointer;
      flex:0 0 auto;
    }
    .spouseAvatar img{ width:100%; height:100%; object-fit:cover; display:block; }

    .footer{
      margin-top:12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      color: var(--muted);
      font-size:12px;
    }

    @media (max-width: 560px){
      .fields{grid-template-columns:1fr;}
      .avatar{width:120px; height:120px; margin:0 auto;}
      .row{justify-content:center;}
      .person{width: 100%;}
    }
  </style>
</head>

<body>
  <header id="headerEl">
    <div class="wrap">
      <h1>Árbol genealógico — <span class="brand">Familia Arango</span></h1>
      <div class="sub">
        Familia Arango, vamos a construir juntos nuestro árbol genealógico, con algo de paciencia pueden editar nombres, fechas, fotos y agregar descendientes (hijos/nietos/bisnietos) desde cada tarjeta. Desde computador o celular, esta es una prueba piloto puede ser algo lenta, pero obtendremos un resultado bonito que vale la pena compartir, solo la familia tendrá el link en esta fase. Toca una foto para cambiarla, para ver a todos los hermanitos Arango es necesario deslizar la pantalla. En celular, toca el nombre para editar (se abre la tarjeta). Los cambios se guardan en vivo para todos.
      </div>

      <div class="toolbar">
        <div class="searchWrap">
          <input class="searchInput" id="searchInput" type="text" placeholder="Buscar persona (nombre)…" autocomplete="off" />
          <button class="btn btn-primary" id="searchBtn" type="button">Buscar</button>
          <div class="searchResults" id="searchResults"></div>
        </div>

        <div class="zoomWrap" title="Zoom del árbol">
          <button class="btn zoomBtn" id="zoomOutBtn" type="button">−</button>
          <span class="pill zoomPct" id="zoomPct">100%</span>
          <button class="btn zoomBtn" id="zoomInBtn" type="button">+</button>
          <button class="btn btn-primary" id="zoomFitBtn" type="button">Ver todo</button>
        </div>

        <div class="pill" title="Estado de guardado">
          <span class="dot bad" id="connDot"></span>
          <span id="connText">Conectando…</span>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="container">

      <section class="cover">
        <div class="cover-top">
          <div class="cover-imgwrap">
            <img id="coverImg" alt="Portada familiar" />
          </div>
          <div class="cover-side">
            <div>
              <h2>Sobre esta familia</h2>
              <!-- ✅ Texto fijo: solo se cambia en código -->
              <p>(Por favor aquí acudo a los poetas o historiadores de la familia a que me envien por mensajes lo que consideran acompaña el camino de los Arango, y que va ir en este lugar. tambien quejas reclamos y/o sugerencias para que construyamos este espacio entre todos).</p>
            </div>
            <div class="cover-actions">
              <label class="btn btn-primary" for="filePicker" id="coverPickLabel">Cambiar foto portada</label>
              <button class="btn btn-danger" id="coverClearBtn" type="button">Eliminar foto</button>
            </div>
          </div>
        </div>
        <div class="strip" id="first11Strip"></div>
      </section>

      <div class="divider"></div>

      <!-- ✅ ÁREA ZOOMABLE (padres + árbol completo) -->
      <div class="treeViewport" id="treeViewport" aria-label="Árbol (zoom y desplazamiento)">
        <div class="treeSpace" id="treeSpace">
          <div class="treeScaler" id="treeScaler">
            <section class="gen couple" id="parentsGen" aria-label="Padres"></section>
            <div class="divider"></div>
            <section class="gen" id="childrenGen" aria-label="Hijos"></section>
          </div>
        </div>
      </div>

    </div>
  </main>

  <input type="file" id="filePicker" accept="image/*"
         style="position:fixed; left:-9999px; top:-9999px; width:1px; height:1px; opacity:0;" />

  <div class="modal" id="editorModal" role="dialog" aria-modal="true">
    <div class="modalPanel">
      <div class="modalHead">
        <b id="editorTitle">Editar</b>
        <button class="btn modalClose" id="editorCloseBtn" type="button">Cerrar</button>
      </div>
      <div id="editorBody"></div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.94.1/+esm";

    const DEFAULT_CFG = {
      url: "https://rgsgdycllmixpdoivize.supabase.co",
      key: "sb_publishable__opz94nN9f8XFTmprITCCw_FWBB5Muu",
      treeId: "familia-arango-v2",
      bucket: "family-photos"
    };

    const headerEl = document.getElementById("headerEl");
    function updateHeaderH(){
      const h = headerEl ? headerEl.offsetHeight : 72;
      document.documentElement.style.setProperty("--headerH", h + "px");
    }
    window.addEventListener("resize", updateHeaderH);

    const connDot  = document.getElementById("connDot");
    const connText = document.getElementById("connText");

    const parentsGen  = document.getElementById("parentsGen");
    const childrenGen = document.getElementById("childrenGen");

    const coverImg = document.getElementById("coverImg");
    const coverPickLabel = document.getElementById("coverPickLabel");
    const coverClearBtn  = document.getElementById("coverClearBtn");
    const first11Strip   = document.getElementById("first11Strip");

    const filePicker = document.getElementById("filePicker");

    const editorModal   = document.getElementById("editorModal");
    const editorCloseBtn= document.getElementById("editorCloseBtn");
    const editorTitle   = document.getElementById("editorTitle");
    const editorBody    = document.getElementById("editorBody");

    // Buscador
    const searchInput   = document.getElementById("searchInput");
    const searchBtn     = document.getElementById("searchBtn");
    const searchResults = document.getElementById("searchResults");

    // Zoom
    const treeViewport = document.getElementById("treeViewport");
    const treeSpace    = document.getElementById("treeSpace");
    const treeScaler   = document.getElementById("treeScaler");

    const zoomOutBtn = document.getElementById("zoomOutBtn");
    const zoomInBtn  = document.getElementById("zoomInBtn");
    const zoomFitBtn = document.getElementById("zoomFitBtn");
    const zoomPct    = document.getElementById("zoomPct");

    let supabase = null;
    let TREE_ID = DEFAULT_CFG.treeId;
    let BUCKET  = DEFAULT_CFG.bucket;

    let savingTimer = null;
    let applyingRemote = false;
    let channel = null;

    let pendingPhotoTarget = null;
    // {type:"cover"} o {type:"person", id} o {type:"spouse", ownerId}

    // ======= Realtime pausado mientras escriben =======
    let isEditing = false;
    let queuedRemote = null;

    document.addEventListener("focusin", (e) => {
      if (e.target instanceof HTMLInputElement && (e.target.dataset.field || e.target.dataset.sfield)) isEditing = true;
    });
    document.addEventListener("focusout", (e) => {
      if (!(e.target instanceof HTMLInputElement) || !(e.target.dataset.field || e.target.dataset.sfield)) return;
      setTimeout(() => {
        const a = document.activeElement;
        const stillEditing = (a instanceof HTMLInputElement && (a.dataset.field || a.dataset.sfield));
        if (stillEditing) return;

        isEditing = false;
        if (queuedRemote) {
          applyingRemote = true;
          state = normalizeState(queuedRemote);
          queuedRemote = null;
          renderAll();
          applyingRemote = false;
        }
      }, 0);
    });

    function setConn(ok, text){
      connDot.className = "dot " + (ok ? "ok" : "bad");
      connText.textContent = text;
    }

    const placeholderImg = (() => {
      const svg =
        `<svg xmlns="http://www.w3.org/2000/svg" width="300" height="300">
          <defs>
            <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0" stop-color="#e2c77c" stop-opacity="0.60"/>
              <stop offset="1" stop-color="#c6a24a" stop-opacity="0.25"/>
            </linearGradient>
          </defs>
          <rect width="100%" height="100%" fill="#f6efe3"/>
          <rect x="22" y="22" width="256" height="256" rx="26" fill="url(#g)" stroke="rgba(0,0,0,0.14)"/>
          <circle cx="150" cy="135" r="42" fill="rgba(0,0,0,0.10)"/>
          <rect x="88" y="190" width="124" height="58" rx="29" fill="rgba(0,0,0,0.10)"/>
          <text x="150" y="52" text-anchor="middle" font-size="16" fill="rgba(0,0,0,0.45)" font-family="Arial">Foto</text>
        </svg>`;
      return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
    })();

    const placeholderCover = (() => {
      const svg =
        `<svg xmlns="http://www.w3.org/2000/svg" width="1400" height="700">
          <defs>
            <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0" stop-color="#f6efe3"/>
              <stop offset="1" stop-color="#e2c77c" stop-opacity="0.65"/>
            </linearGradient>
          </defs>
          <rect width="100%" height="100%" fill="url(#g)"/>
          <text x="50%" y="48%" text-anchor="middle" font-size="44" fill="rgba(0,0,0,0.35)" font-family="Arial">Poner Foto familiar</text>
          <text x="50%" y="56%" text-anchor="middle" font-size="22" fill="rgba(0,0,0,0.28)" font-family="Arial">Los 11 Arango Originales</text>
        </svg>`;
      return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
    })();

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function escapeAttr(str) { return escapeHtml(str).replaceAll("\n"," "); }

    function yearRange(birth, death){
      const y = (d) => (d && String(d).length >= 4 ? String(d).slice(0,4) : "");
      const b = y(birth), dth = y(death);
      if (b && dth) return `${b}–${dth}`;
      if (b && !dth) return `${b}–`;
      if (!b && dth) return `–${dth}`;
      return "";
    }

    function makeId(prefix="n"){
      if (crypto?.randomUUID) return `${prefix}_${crypto.randomUUID()}`;
      return `${prefix}_${Date.now()}_${Math.random().toString(16).slice(2)}`;
    }

    function makeSpouse(){
      return {
        id: makeId("s"),
        name:"",
        birth:"",
        death:"",
        photo_url: placeholderImg,
        photo_path:""
      };
    }

    function makePerson({ role="", id=null } = {}){
      return {
        id: id || makeId("p"),
        role,
        name:"",
        birth:"",
        death:"",
        photo_url: placeholderImg,
        photo_path:"",
        spouse: null,     // ✅ soporte de pareja
        children:[]
      };
    }

    const defaultState = {
      familyName: "Arango",
      cover_photo_url: placeholderCover,
      cover_photo_path: "",
      parents: [
        { ...makePerson({ id:"p1", role:"Padre" }) },
        { ...makePerson({ id:"p2", role:"Madre" }) },
      ],
      children: Array.from({ length: 11 }, (_, i) => makePerson({ id:`c${i+1}`, role:`Hijo/a ${i+1}` }))
    };

    let state = structuredClone(defaultState);

    function normalizeSpouse(sp){
      if (!sp) return null;
      if (!sp.id) sp.id = makeId("s");
      if (!sp.photo_url) sp.photo_url = placeholderImg;
      if (sp.photo_url === "") sp.photo_url = placeholderImg;
      if (!("photo_path" in sp)) sp.photo_path = "";
      if (!("name" in sp)) sp.name = "";
      if (!("birth" in sp)) sp.birth = "";
      if (!("death" in sp)) sp.death = "";
      return sp;
    }

    function normalizeNode(node){
      if (!node) return;
      if (!Array.isArray(node.children)) node.children = [];
      if (!node.photo_url) node.photo_url = placeholderImg;
      if (node.photo_url === "") node.photo_url = placeholderImg;

      node.spouse = normalizeSpouse(node.spouse);

      node.children.forEach(normalizeNode);
    }
    function normalizeState(s){
      if (!s) return structuredClone(defaultState);
      if (!Array.isArray(s.parents) || s.parents.length < 2) s.parents = structuredClone(defaultState.parents);
      if (!Array.isArray(s.children)) s.children = [];
      s.parents.forEach(normalizeNode);
      s.children.forEach(normalizeNode);

      if (!s.cover_photo_url) s.cover_photo_url = placeholderCover;
      if (s.cover_photo_url === "") s.cover_photo_url = placeholderCover;
      if (!("cover_photo_path" in s)) s.cover_photo_path = "";

      return s;
    }

    // ======= Buscar (con depth) =======
    function findInChildren(parentNode, id, depth){
      if (!parentNode?.children?.length) return null;
      for (const child of parentNode.children) {
        if (child.id === id) {
          return { node: child, depth };
        }
        if (child.spouse?.id === id) {
          return { node: child, depth, hitSpouse: true }; // devolvemos dueño
        }
        const deeper = findInChildren(child, id, depth + 1);
        if (deeper) return deeper;
      }
      return null;
    }

    function findNodeById(id){
      for (const p of state.parents) {
        if (p.id === id) return { node: p, depth: 0, hitSpouse:false };
        if (p.spouse?.id === id) return { node: p, depth: 0, hitSpouse:true };
        const hit = findInChildren(p, id, 1);
        if (hit) return hit;
      }
      for (const c of state.children) {
        if (c.id === id) return { node: c, depth: 1, hitSpouse:false };
        if (c.spouse?.id === id) return { node: c, depth: 1, hitSpouse:true };
        const hit = findInChildren(c, id, 2);
        if (hit) return hit;
      }
      return null;
    }

    function patchNode(id, patch, { render=true } = {}){
      const hit = findNodeById(id);
      if (!hit?.node) return;
      Object.assign(hit.node, patch);
      if (render) renderAll();
    }

    function patchSpouse(ownerId, patch, { render=true } = {}){
      const hit = findNodeById(ownerId);
      if (!hit?.node) return;
      if (!hit.node.spouse) hit.node.spouse = makeSpouse();
      Object.assign(hit.node.spouse, patch);
      if (render) renderAll();
    }

    function addChildTo(parentId){
      const hit = findNodeById(parentId);
      if (!hit?.node) return;
      const parent = hit.node;
      if (!Array.isArray(parent.children)) parent.children = [];

      const nextIndex = parent.children.length + 1;
      const child = makePerson({ role: `Hijo/a ${nextIndex}` });
      parent.children.push(child);

      renderAll();
      scheduleSave();
    }

    function isOriginal11(id){
      return /^c([1-9]|10|11)$/.test(id);
    }

    // ✅ Eliminar con doble confirmación y bloqueos p1/p2 y c1..c11
    function removeNode(id){
      if (id === "p1" || id === "p2") return alert("No se pueden eliminar los padres.");
      if (isOriginal11(id)) return alert("Los 11 hermanos originales (c1–c11) no se eliminan, solo se editan.");

      // encontrar dueño en árbol para borrado real
      const hit = findContainerArrayAndIndex(id);
      if (!hit) return;

      const who = (hit.item?.name && hit.item.name.trim())
        ? hit.item.name.trim()
        : (hit.item?.role || id);

      const ok1 = confirm(`¿Seguro que deseas eliminar a "${who}"?\n\nEsto elimina a esta persona y todos sus descendientes.`);
      if (!ok1) return;

      const typed = prompt('Para confirmar, escribe exactamente: ELIMINAR');
      if (typed !== "ELIMINAR") return;

      hit.arr.splice(hit.idx, 1);
      renderAll();
      scheduleSave();
    }

    // helper para eliminar: hallar array contenedor
    function findContainerArrayAndIndex(id){
      // dentro de parents children arrays
      const walkArr = (arr) => {
        for (let i=0;i<arr.length;i++){
          const n = arr[i];
          if (n.id === id) return { arr, idx:i, item:n };
          if (n.children?.length){
            const r = walkArr(n.children);
            if (r) return r;
          }
        }
        return null;
      };

      // hijos raíz viven en state.children
      const r1 = walkArr(state.children);
      if (r1) return r1;

      // descendientes colgados de padres (por si acaso)
      for (const p of state.parents){
        const r2 = walkArr(p.children || []);
        if (r2) return r2;
      }
      return null;
    }

    // ======= Modal editor =======
    let editorFocusSpouse = false;

    function openEditor(nodeId, { focusSpouse=false } = {}){
      const hit = findNodeById(nodeId);
      if (!hit?.node) return;

      const owner = hit.node;
      const isSpouseClick = !!hit.hitSpouse;
      editorFocusSpouse = focusSpouse || isSpouseClick;

      const title = (owner.name && owner.name.trim()) ? owner.name.trim() : (owner.role || "Editar");
      editorTitle.textContent = `Editar: ${title}`;

      editorBody.innerHTML = "";

      const removable = !(owner.id === "p1" || owner.id === "p2" || isOriginal11(owner.id));
      const card = editorPersonCard(owner, { removable });

      if (owner.id === "p1" || owner.id === "p2") card.classList.add("parent-card");
      editorBody.appendChild(card);

      editorModal.classList.add("show");

      // si el click fue en pareja, bajar al bloque pareja
      if (editorFocusSpouse) {
        setTimeout(() => {
          const b = editorBody.querySelector("[data-spouse-block='1']");
          if (b) b.scrollIntoView({ behavior:"smooth", block:"start" });
        }, 0);
      }
    }

    function closeEditor(){
      editorModal.classList.remove("show");
      editorBody.innerHTML = "";
      renderAll();
    }

    editorCloseBtn.addEventListener("click", closeEditor);
    editorModal.addEventListener("click", (e) => {
      if (e.target === editorModal) closeEditor();
    });

    // ======= Portada =======
    function renderCover(){
      coverImg.src = state.cover_photo_url || placeholderCover;

      first11Strip.innerHTML = "";
      const first11 = (state.children || []).slice(0, 11);
      first11.forEach((p, idx) => {
        const chip = document.createElement("div");
        chip.className = "sib";
        const img = document.createElement("img");
        img.src = p.photo_url || placeholderImg;
        img.alt = `Hijo ${idx+1}`;
        const name = document.createElement("span");
        name.textContent = (p.name && p.name.trim()) ? p.name.trim() : `Hijo ${idx+1}`;
        chip.appendChild(img);
        chip.appendChild(name);
        chip.addEventListener("click", () => openEditor(p.id));
        first11Strip.appendChild(chip);
      });
    }

    // ======= Tarjeta (modal) =======
    function editorPersonCard(node, { removable=false } = {}){
      const el = document.createElement("article");
      el.className = "person";
      el.dataset.id = node.id;

      const imgSrc = node.photo_url || placeholderImg;

      const spouse = node.spouse;

      el.innerHTML = `
        <div class="role">
          <b>${escapeHtml(node.role || "")}</b>
          ${removable ? `<button class="smallbtn remove" data-action="remove" type="button">Eliminar</button>` : `<span></span>`}
        </div>

        <div class="row">
          <label class="avatar" for="filePicker" data-action="photo" title="Toca para cambiar la foto">
            <img alt="Foto" src="${imgSrc}">
          </label>

          <div class="photo-actions">
            <button class="smallbtn addkid" data-action="addChild" type="button">+ Agregar hijo/a</button>
            <button class="smallbtn" data-action="clearPhoto" type="button">Quitar foto</button>
          </div>
        </div>

        <div class="fields">
          <label>Nombre
            <input type="text" data-field="name" placeholder="Escribe el nombre" value="${escapeAttr(node.name || "")}">
          </label>
          <label>Nacimiento
            <input type="date" data-field="birth" value="${escapeAttr(node.birth || "")}">
          </label>
          <label>Fallecimiento (opcional)
            <input type="date" data-field="death" value="${escapeAttr(node.death || "")}">
          </label>
        </div>

        <div class="spouseBlock" data-spouse-block="1">
          <div class="spouseHead">
            <b>Pareja</b>
            ${spouse
              ? `<button class="smallbtn remove" data-action="removeSpouse" type="button">Quitar pareja</button>`
              : `<button class="smallbtn addsp" data-action="addSpouse" type="button">+ Agregar pareja</button>`
            }
          </div>

          ${spouse ? `
            <div class="spouseCard">
              <div class="spouseRow">
                <label class="spouseAvatar" for="filePicker" data-action="spousePhoto" title="Toca para cambiar la foto de la pareja">
                  <img alt="Foto pareja" src="${escapeAttr(spouse.photo_url || placeholderImg)}">
                </label>
                <div style="flex:1 1 auto;">
                  <div class="fields" style="margin-top:0;">
                    <label>Nombre
                      <input type="text" data-sfield="name" placeholder="Nombre pareja" value="${escapeAttr(spouse.name || "")}">
                    </label>
                    <label>Nacimiento
                      <input type="date" data-sfield="birth" value="${escapeAttr(spouse.birth || "")}">
                    </label>
                    <label>Fallecimiento (opcional)
                      <input type="date" data-sfield="death" value="${escapeAttr(spouse.death || "")}">
                    </label>
                  </div>
                  <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
                    <button class="smallbtn" data-action="clearSpousePhoto" type="button">Quitar foto pareja</button>
                  </div>
                </div>
              </div>
            </div>
          ` : `
            <div style="color: var(--muted); font-size:12px;">
              (Opcional) Agrega la pareja para verla al lado en el árbol.
            </div>
          `}
        </div>

        <div class="footer">
          <span>${escapeHtml(node.id)}</span>
          <span>Familia Arango</span>
        </div>
      `;

      // target upload (persona o pareja)
      el.addEventListener("pointerdown", (e) => {
        const labP = e.target.closest('label[data-action="photo"]');
        if (labP) {
          pendingPhotoTarget = { type:"person", id: node.id };
          filePicker.value = "";
          return;
        }
        const labS = e.target.closest('label[data-action="spousePhoto"]');
        if (labS) {
          pendingPhotoTarget = { type:"spouse", ownerId: node.id };
          filePicker.value = "";
          return;
        }
      });

      // botones
      el.addEventListener("click", (e) => {
        const btn = e.target.closest("button");
        if (!btn) return;

        const action = btn.dataset.action;
        if (!action) return;

        if (action === "clearPhoto") {
          patchNode(node.id, { photo_url: placeholderImg, photo_path: "" }, { render:false });
          scheduleSave();
          const img = el.querySelector(".avatar img");
          if (img) img.src = placeholderImg;
          return;
        }

        if (action === "addChild") {
          addChildTo(node.id);
          openEditor(node.id);
          return;
        }

        if (action === "remove") {
          removeNode(node.id);
          closeEditor();
          return;
        }

        if (action === "addSpouse") {
          patchNode(node.id, { spouse: makeSpouse() }, { render:false });
          scheduleSave();
          openEditor(node.id, { focusSpouse:true });
          return;
        }

        if (action === "removeSpouse") {
          patchNode(node.id, { spouse: null }, { render:false });
          scheduleSave();
          openEditor(node.id);
          return;
        }

        if (action === "clearSpousePhoto") {
          patchSpouse(node.id, { photo_url: placeholderImg, photo_path:"" }, { render:false });
          scheduleSave();
          openEditor(node.id, { focusSpouse:true });
          return;
        }
      });

      // inputs (sin re-render)
      el.addEventListener("input", (e) => {
        const input = e.target;
        if (!(input instanceof HTMLInputElement)) return;

        const field = input.dataset.field;
        const sfield = input.dataset.sfield;

        if (field) {
          patchNode(node.id, { [field]: input.value }, { render:false });
          scheduleSave();
        } else if (sfield) {
          patchSpouse(node.id, { [sfield]: input.value }, { render:false });
          scheduleSave();
        }
      });

      return el;
    }

    // ======= Render nodo =======
    function renderNodeCircle(node, cls, { isSpouse=false, ownerId=null } = {}){
      const el = document.createElement("div");
      el.className = `node ${cls}` + (isSpouse ? " spouseNode" : "");
      el.dataset.id = node.id;
      if (ownerId) el.dataset.owner = ownerId;

      const name = (node.name && node.name.trim()) ? node.name.trim() : "Sin nombre";
      const yrs  = yearRange(node.birth, node.death);

      el.innerHTML = `
        <div class="circle"><img alt="Foto" src="${escapeAttr(node.photo_url || placeholderImg)}"></div>
        <div class="labelName">${escapeHtml(name)}</div>
        <div class="labelYears">${escapeHtml(yrs)}</div>
      `;

      el.addEventListener("click", () => {
        if (isSpouse && ownerId) openEditor(ownerId, { focusSpouse:true });
        else openEditor(node.id);
      });

      return el;
    }

    function renderPersonUnit(node, cls){
      const unit = document.createElement("div");
      unit.className = "personUnit";
      unit.appendChild(renderNodeCircle(node, cls, { isSpouse:false }));

      if (node.spouse) {
        unit.appendChild(renderNodeCircle(node.spouse, cls, { isSpouse:true, ownerId: node.id }));
      }
      return unit;
    }

    // ======= SUBÁRBOL =======
    const MAX_DEPTH = 8;

    function depthClass(depth){
      if (depth === 1) return "lvl-1";
      if (depth === 2) return "lvl-2";
      return "lvl-3";
    }

    function renderSubtree(node, depth = 0, { isOriginal = false } = {}) {
      const wrap = document.createElement("div");
      wrap.className = "subtree";

      const cls = isOriginal ? "lvl-original" : depthClass(depth);

      // ✅ aquí se renderiza persona + pareja en la misma línea
      wrap.appendChild(renderPersonUnit(node, cls));

      if (Array.isArray(node.children) && node.children.length > 0 && depth < MAX_DEPTH) {
        const group = document.createElement("div");
        group.className = "childrenGroup";

        const row = document.createElement("div");
        row.className = "childrenRow";

        node.children.forEach(ch => {
          const cw = document.createElement("div");
          cw.className = "childWrap";
          cw.appendChild(renderSubtree(ch, depth + 1, { isOriginal: false }));
          row.appendChild(cw);
        });

        group.appendChild(row);
        wrap.appendChild(group);
      }

      return wrap;
    }

    // ======= Zoom/Pan =======
    let zoom = 1;
    const minZoom = 0.06;  // ✅ permite ver TODO aunque columnas sean más anchas
    const maxZoom = 2.6;
    let didAutoFit = false;

    function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }

    function updateZoomSpace(){
      if (!treeScaler || !treeSpace) return;
      const baseW = treeScaler.offsetWidth;
      const baseH = treeScaler.offsetHeight;
      treeSpace.style.width  = Math.ceil(baseW * zoom) + "px";
      treeSpace.style.height = Math.ceil(baseH * zoom) + "px";
      treeScaler.style.transform = `scale(${zoom})`;
      zoomPct.textContent = Math.round(zoom * 100) + "%";
    }

    function applyZoom(next, { keepCenter=true, anchorTop=false } = {}){
      const vp = treeViewport;
      const prev = zoom;

      let cx=0, cy=0;
      if (keepCenter) {
        cx = (vp.scrollLeft + vp.clientWidth/2) / prev;
        cy = (vp.scrollTop + vp.clientHeight/2) / prev;
      }

      zoom = clamp(next, minZoom, maxZoom);
      updateZoomSpace();

      if (keepCenter) {
        vp.scrollLeft = cx * zoom - vp.clientWidth/2;
        vp.scrollTop  = cy * zoom - vp.clientHeight/2;
      }
      if (anchorTop) {
        vp.scrollTop = 0; // ✅ garantiza ver P1/P2
      }
    }

    function fitAll(){
      const vp = treeViewport;

      // medir en zoom=1
      const old = zoom;
      zoom = 1;
      updateZoomSpace();

      const baseW = treeScaler.offsetWidth;
      const baseH = treeScaler.offsetHeight;

      const z = Math.min(vp.clientWidth / baseW, vp.clientHeight / baseH);
      zoom = old; // volver antes de aplicar

      applyZoom(z, { keepCenter:false, anchorTop:true });
      // centrar horizontal para que salgan los 11
      vp.scrollLeft = Math.max(0, (treeSpace.offsetWidth - vp.clientWidth)/2);
    }

    // botones
    zoomInBtn.addEventListener("click", () => applyZoom(zoom * 1.18, { keepCenter:true }));
    zoomOutBtn.addEventListener("click", () => applyZoom(zoom / 1.18, { keepCenter:true }));
    zoomFitBtn.addEventListener("click", () => fitAll());

    // rueda/trackpad: zoom con CTRL (o pinch en trackpad)
    treeViewport.addEventListener("wheel", (e) => {
      if (!(e.ctrlKey || e.metaKey)) return;
      e.preventDefault();
      const factor = Math.exp(-e.deltaY / 250);
      applyZoom(zoom * factor, { keepCenter:true });
    }, { passive:false });

    // pan arrastrando
    let panning = false;
    let panStartX=0, panStartY=0, panScrollL=0, panScrollT=0;

    treeViewport.addEventListener("pointerdown", (e) => {
      // no pan si hacen click en botones/inputs (por seguridad)
      const tag = (e.target?.tagName || "").toLowerCase();
      if (tag === "input" || tag === "button" || tag === "label") return;
      panning = true;
      panStartX = e.clientX;
      panStartY = e.clientY;
      panScrollL = treeViewport.scrollLeft;
      panScrollT = treeViewport.scrollTop;
      treeViewport.setPointerCapture(e.pointerId);
    });

    treeViewport.addEventListener("pointermove", (e) => {
      if (!panning) return;
      const dx = e.clientX - panStartX;
      const dy = e.clientY - panStartY;
      treeViewport.scrollLeft = panScrollL - dx;
      treeViewport.scrollTop  = panScrollT - dy;
    });

    treeViewport.addEventListener("pointerup", () => { panning = false; });
    treeViewport.addEventListener("pointercancel", () => { panning = false; });

    // ======= Render general =======
    function renderAll(){
      renderCover();

      // Padres
      parentsGen.innerHTML = "";
      const cw = document.createElement("div");
      cw.className = "coupleWrap";
      parentsGen.appendChild(cw);

      cw.appendChild(renderPersonUnit(state.parents[0], "lvl-parent"));
      cw.appendChild(renderPersonUnit(state.parents[1], "lvl-parent"));

      // Hijos (11 columnas)
      childrenGen.innerHTML = "";

      const grid = document.createElement("div");
      grid.className = "treeGrid";

      const kids = state.children || [];
      if (kids.length > 11) grid.classList.add("moreCols");

      kids.forEach((k, idx) => {
        const col = document.createElement("div");
        col.appendChild(renderSubtree(k, 0, { isOriginal: idx < 11 }));
        grid.appendChild(col);
      });

      childrenGen.appendChild(grid);

      // ✅ actualizar espacio del zoom (sin cambiar zoom actual)
      requestAnimationFrame(() => {
        updateZoomSpace();
        if (!didAutoFit) {
          fitAll();     // ✅ zoom inicial = ver todo con P1/P2
          didAutoFit = true;
        }
      });
    }

    // ======= Portada acciones =======
    coverPickLabel.addEventListener("pointerdown", () => {
      pendingPhotoTarget = { type:"cover" };
      filePicker.value = "";
    });

    coverClearBtn.addEventListener("click", () => {
      state.cover_photo_url = placeholderCover;
      state.cover_photo_path = "";
      renderAll();
      scheduleSave();
    });

    // Subir fotos (cover/persona/pareja)
    filePicker.addEventListener("change", async () => {
      const file = filePicker.files?.[0];
      if (!file || !pendingPhotoTarget) return;
      if (!supabase) return alert("No hay conexión con Supabase.");

      try {
        const maxSide = (pendingPhotoTarget.type === "cover") ? 1400 : 900;
        const jpgBlob = await compressImageToJpeg(file, maxSide, 0.85);

        const ts = Date.now();
        const path =
          (pendingPhotoTarget.type === "cover")  ? `${TREE_ID}/cover_${ts}.jpg` :
          (pendingPhotoTarget.type === "person") ? `${TREE_ID}/${pendingPhotoTarget.id}_${ts}.jpg` :
          `${TREE_ID}/spouse_${pendingPhotoTarget.ownerId}_${ts}.jpg`;

        const { error: upErr } = await supabase.storage
          .from(BUCKET)
          .upload(path, jpgBlob, { contentType: "image/jpeg" });
        if (upErr) throw upErr;

        const { data: pub } = supabase.storage.from(BUCKET).getPublicUrl(path);
        const publicUrl = pub?.publicUrl || placeholderImg;

        if (pendingPhotoTarget.type === "cover") {
          state.cover_photo_url = publicUrl;
          state.cover_photo_path = path;
          renderAll();
          scheduleSave();
        } else if (pendingPhotoTarget.type === "person") {
          patchNode(pendingPhotoTarget.id, { photo_url: publicUrl, photo_path: path }, { render:false });
          scheduleSave();
          if (editorModal.classList.contains("show")) openEditor(pendingPhotoTarget.id);
          else renderAll();
        } else {
          // spouse
          patchSpouse(pendingPhotoTarget.ownerId, { photo_url: publicUrl, photo_path: path }, { render:false });
          scheduleSave();
          openEditor(pendingPhotoTarget.ownerId, { focusSpouse:true });
        }

        pendingPhotoTarget = null;

      } catch (e) {
        console.error(e);
        alert("No se pudo subir la foto. Revisa bucket/policies (insert/select) y que el bucket sea público.");
      }
    });

    async function compressImageToJpeg(file, maxSide=900, quality=0.85){
      const img = await fileToImage(file);
      const { w, h } = fitBox(img.width, img.height, maxSide);
      const canvas = document.createElement("canvas");
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, w, h);
      return await new Promise((resolve) => canvas.toBlob(resolve, "image/jpeg", quality));
    }
    function fitBox(w, h, maxSide){
      const scale = Math.min(1, maxSide / Math.max(w,h));
      return { w: Math.round(w*scale), h: Math.round(h*scale) };
    }
    function fileToImage(file){
      return new Promise((resolve, reject) => {
        const url = URL.createObjectURL(file);
        const img = new Image();
        img.onload = () => { URL.revokeObjectURL(url); resolve(img); };
        img.onerror = reject;
        img.src = url;
      });
    }

    // Guardado “debounced”
    function scheduleSave(){
      if (!supabase) return;
      if (applyingRemote) return;
      clearTimeout(savingTimer);
      savingTimer = setTimeout(saveRemote, 650);
    }

    async function saveRemote(){
      if (!supabase) return;
      if (applyingRemote) return;

      const payload = {
        id: TREE_ID,
        data: state,
        updated_at: new Date().toISOString()
      };

      const { error } = await supabase
        .from("family_trees")
        .upsert(payload, { onConflict: "id" });

      if (error) {
        console.error(error);
        setConn(false, "Error guardando");
      } else {
        setConn(true, "Guardado en vivo");
      }
    }

    async function ensureRow(){
      const { data, error } = await supabase
        .from("family_trees")
        .select("data")
        .eq("id", TREE_ID)
        .maybeSingle();

      if (error) {
        console.error(error);
        setConn(false, "No puedo leer (RLS)");
        return;
      }

      if (!data) {
        const { error: insErr } = await supabase
          .from("family_trees")
          .insert({ id: TREE_ID, data: defaultState });

        if (insErr) {
          console.error(insErr);
          setConn(false, "No puedo crear (RLS)");
          return;
        }
        state = structuredClone(defaultState);
      } else {
        state = normalizeState(data.data || structuredClone(defaultState));
      }

      renderAll();
      setConn(true, "Conectado");
    }

    function subscribeRealtime(){
      if (channel) {
        try { supabase.removeChannel(channel); } catch {}
      }

      channel = supabase
        .channel(`tree:${TREE_ID}`)
        .on(
          "postgres_changes",
          { event:"*", schema:"public", table:"family_trees", filter:`id=eq.${TREE_ID}` },
          (payload) => {
            const newData = payload?.new?.data;
            if (!newData) return;

            if (isEditing) { queuedRemote = newData; return; }

            applyingRemote = true;
            state = normalizeState(newData);
            renderAll();
            applyingRemote = false;

            setConn(true, "Actualizado en vivo");
          }
        )
        .subscribe();
    }

    async function boot(){
      TREE_ID = DEFAULT_CFG.treeId;
      BUCKET  = DEFAULT_CFG.bucket;
      supabase = createClient(DEFAULT_CFG.url, DEFAULT_CFG.key);

      setConn(true, "Conectando…");
      await ensureRow();
      subscribeRealtime();
    }

    // ======= Buscador (incluye parejas) =======
    function collectPeople(){
      const out = [];
      const walk = (node, depth, rootId) => {
        out.push({
          id: node.id,
          ownerId: null,
          name: (node.name || "").trim(),
          role: node.role || "",
          depth,
          rootId: rootId || node.id,
          photo_url: node.photo_url || placeholderImg
        });

        if (node.spouse) {
          out.push({
            id: node.spouse.id,
            ownerId: node.id,
            name: (node.spouse.name || "").trim(),
            role: "Pareja",
            depth,
            rootId: rootId || node.id,
            photo_url: node.spouse.photo_url || placeholderImg
          });
        }

        (node.children || []).forEach(ch => walk(ch, depth + 1, rootId || node.id));
      };

      state.parents.forEach(p => walk(p, 0, p.id));
      (state.children || []).forEach(c => walk(c, 1, c.id));
      return out;
    }

    function showResults(items){
      searchResults.innerHTML = "";
      if (!items.length) {
        searchResults.classList.remove("show");
        return;
      }
      items.forEach(it => {
        const div = document.createElement("div");
        div.className = "srItem";
        div.innerHTML = `
          <div class="srThumb"><img alt="" src="${escapeAttr(it.photo_url || placeholderImg)}"></div>
          <div class="srText">
            <div class="srName">${escapeHtml(it.name || "Sin nombre")}</div>
            <div class="srMeta">${escapeHtml(it.role || it.id)} • id: ${escapeHtml(it.id)}</div>
          </div>
        `;
        div.addEventListener("click", () => {
          searchResults.classList.remove("show");
          goToPerson(it.id, { open:true, ownerId: it.ownerId });
        });
        searchResults.appendChild(div);
      });
      searchResults.classList.add("show");
    }

    function panToElement(el){
      const vpRect = treeViewport.getBoundingClientRect();
      const r = el.getBoundingClientRect();
      const dx = (r.left + r.width/2) - (vpRect.left + vpRect.width/2);
      const dy = (r.top + r.height/2) - (vpRect.top + vpRect.height/2);
      treeViewport.scrollLeft += dx;
      treeViewport.scrollTop  += dy;
    }

    function goToPerson(id, { open=false, ownerId=null } = {}){
      const el = treeScaler.querySelector(`[data-id="${CSS.escape(id)}"]`);
      if (el) {
        panToElement(el);
        el.classList.add("flash");
        setTimeout(() => el.classList.remove("flash"), 1400);
      }
      if (open) {
        if (ownerId) openEditor(ownerId, { focusSpouse:true });
        else openEditor(id);
      }
    }

    function runSearch(openFirst=true){
      const q = (searchInput.value || "").trim().toLowerCase();
      if (!q) { searchResults.classList.remove("show"); return; }
      const all = collectPeople();
      const matches = all
        .filter(p => (p.name || "").toLowerCase().includes(q))
        .slice(0, 10);

      if (openFirst && matches[0]) {
        searchResults.classList.remove("show");
        goToPerson(matches[0].id, { open:true, ownerId: matches[0].ownerId });
      } else {
        showResults(matches);
      }
    }

    searchBtn.addEventListener("click", () => runSearch(true));
    searchInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") { e.preventDefault(); runSearch(true); }
      if (e.key === "Escape") { searchResults.classList.remove("show"); }
    });
    searchInput.addEventListener("input", () => runSearch(false));

    document.addEventListener("click", (e) => {
      if (!searchResults.contains(e.target) && e.target !== searchInput && e.target !== searchBtn) {
        searchResults.classList.remove("show");
      }
    });

    // Init
    (async () => {
      updateHeaderH();
      state = normalizeState(state);
      renderAll();
      await boot();
    })();
  </script>
</body>
</html>




