<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Árbol genealógico — Familia Arango</title>

  <style>
    :root{
      /* Paleta cálida */
      --bg:#f6efe3;
      --card:#fff7ea;
      --card2:#fbf1df;
      --text:#151515;
      --muted:#6b5f4a;
      --gold:#c6a24a;
      --gold2:#e2c77c;
      --line:#dcc9a5;
      --shadow:0 10px 25px rgba(0,0,0,.12);
      --radius:18px;

      --btn-bg:#151515;
      --btn-text:#f6efe3;
      --btn-border:rgba(0,0,0,.18);

      --danger:#b6463f;
      --ok:#2f8f6b;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      background:
        radial-gradient(900px 500px at 20% 10%, rgba(198,162,74,.18), transparent 60%),
        radial-gradient(800px 500px at 85% 15%, rgba(0,0,0,.08), transparent 60%),
        var(--bg);
      color:var(--text);
    }

    header{
      position:sticky; top:0; z-index:10;
      background: rgba(246,239,227,.88);
      backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(0,0,0,.08);
    }

    .wrap{max-width:1200px; margin:0 auto; padding:18px 16px;}
    h1{
      margin:0;
      font-size:22px;
      letter-spacing:.2px;
      display:flex;
      gap:10px;
      align-items:baseline;
      flex-wrap:wrap;
    }
    .brand{color:var(--gold); font-weight:900;}
    .sub{
      margin-top:8px;
      color:var(--muted);
      font-size:13px;
      line-height:1.4;
    }

    .toolbar{
      margin-top:14px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.55);
      color: var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .dot{width:9px; height:9px; border-radius:50%;}
    .dot.ok{background: var(--ok); box-shadow: 0 0 0 4px rgba(47,143,107,.12);}
    .dot.bad{background: var(--danger); box-shadow: 0 0 0 4px rgba(182,70,63,.12);}

    main{padding:18px 16px 34px;}
    .container{max-width:1200px; margin:0 auto;}

    /* Portada */
    .cover{
      background: linear-gradient(180deg, var(--card), var(--card2));
      border:1px solid rgba(0,0,0,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      margin-bottom: 18px;
    }
    .cover-top{
      display:grid;
      grid-template-columns: 1.6fr 1fr;
      gap: 14px;
      padding: 14px;
      align-items: stretch;
    }
    .cover-imgwrap{
      border-radius: 16px;
      overflow:hidden;
      border:1px solid rgba(0,0,0,.10);
      background: rgba(0,0,0,.04);
      min-height: 230px;
    }
    .cover-imgwrap img{width:100%; height:100%; object-fit:cover; display:block;}
    .cover-side{
      display:flex; flex-direction:column; gap:10px;
      justify-content:space-between;
    }
    .cover-side h2{margin:0; font-size:16px; letter-spacing:.2px;}
    .cover-side p{margin:6px 0 0 0; color:var(--muted); font-size:12px; line-height:1.35;}

    .cover-actions{display:flex; flex-wrap:wrap; gap:10px; margin-top:10px;}

    .btn{
      cursor:pointer;
      border:1px solid var(--btn-border);
      background: var(--btn-bg);
      color: var(--btn-text);
      padding:8px 10px;
      border-radius: 12px;
      transition: transform .05s ease, opacity .15s ease;
      font-weight:900;
      font-size:12px;
      box-shadow: 0 6px 16px rgba(0,0,0,.10);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      user-select:none;
      text-decoration:none;
    }
    .btn:hover{opacity:.92}
    .btn:active{transform: translateY(1px);}
    .btn-primary{
      background: linear-gradient(180deg, var(--gold2), var(--gold));
      color:#201a10;
      border-color: rgba(0,0,0,.14);
    }
    .btn-danger{
      background: rgba(182,70,63,.14);
      color:#4a1411;
      border-color: rgba(182,70,63,.30);
      box-shadow:none;
    }

    .strip{
      padding: 0 14px 14px 14px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    .sib{
      display:flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius: 999px;
      border:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.55);
    }
    .sib img{
      width:34px; height:34px;
      border-radius: 999px;
      object-fit: cover;
      border:1px solid rgba(0,0,0,.12);
      display:block;
    }
    .sib span{
      font-size:12px;
      color: var(--text);
      max-width: 150px;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* Árbol */
    .divider{height:1px; background: rgba(0,0,0,.10); margin: 16px 0;}
    .gen{display:flex; justify-content:center; gap:18px; flex-wrap:wrap;}

    .person{
      width: 300px; max-width: calc(100vw - 32px);
      background: linear-gradient(180deg, var(--card), var(--card2));
      border: 1px solid rgba(0,0,0,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      position:relative;
    }
    .person.sub{width: 280px;}

    .role{
      font-size:12px;
      color: var(--muted);
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:10px;
    }
    .role b{color: var(--text); font-size:12px; letter-spacing:.2px;}

    .row{display:flex; gap:12px; align-items:center;}

    .avatar{
      width:98px; height:98px;
      border-radius:18px;
      border: 1px solid rgba(0,0,0,.12);
      overflow:hidden;
      background: rgba(0,0,0,.04);
      flex: 0 0 auto;
      cursor:pointer;
      user-select:none;
    }
    .avatar img{width:100%; height:100%; object-fit:cover; display:block;}

    .photo-actions{
      display:flex;
      flex-direction:column;
      gap:8px;
      flex: 1 1 auto;
    }

    .smallbtn{
      padding:7px 9px;
      border-radius: 12px;
      font-size:12px;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.55);
      color: var(--text);
      box-shadow:none;
      font-weight:900;
      cursor:pointer;
      user-select:none;
      text-align:center;
    }
    .smallbtn:hover{opacity:.92}
    .smallbtn.addkid{background: rgba(198,162,74,.20); border-color: rgba(198,162,74,.35);}
    .smallbtn.remove{background: rgba(182,70,63,.12); border-color: rgba(182,70,63,.28); color:#4a1411;}

    .mini{display:none;}

    .fields{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    label{display:flex; flex-direction:column; gap:6px; font-size:12px; color: var(--muted);}
    input[type="text"], input[type="date"]{
      width:100%;
      padding:10px 10px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.65);
      color: var(--text);
      outline:none;
    }
    input[type="text"]::placeholder{color: rgba(107,95,74,.65);}
    input[type="text"]:focus, input[type="date"]:focus{
      border-color: rgba(198,162,74,.55);
      box-shadow: 0 0 0 4px rgba(198,162,74,.16);
    }

    .footer{
      margin-top:12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      color: var(--muted);
      font-size:12px;
    }

    /* Descendientes */
    .kids{
      margin-top:12px;
      padding-left:14px;
      border-left:2px solid rgba(220,201,165,.95);
      display:flex;
      flex-wrap:wrap;
      gap:12px;
    }
    .kids .kidwrap{position:relative; padding-left:10px;}
    .kids .kidwrap::before{
      content:"";
      position:absolute;
      left:-14px;
      top:30px;
      width:14px;
      height:2px;
      background: rgba(220,201,165,.95);
      border-radius:2px;
    }

    @media (max-width: 860px){
      .cover-top{grid-template-columns: 1fr;}
      .cover-imgwrap{min-height: 210px;}
    }

    /* Móvil: compacto y “toca para editar” */
    @media (max-width: 560px){
      .fields{grid-template-columns:1fr;}
      .avatar{width:120px; height:120px; margin:0 auto;}
      .row{justify-content:center;}
      .person{width: 170px; padding: 10px;}
      .person.expanded{width: 100%;}

      .mini{
        display:block;
        text-align:center;
        margin-top:10px;
        cursor:pointer;
        user-select:none;
      }
      .mini-name{font-weight: 900; font-size: 13px; line-height: 1.1;}
      .mini-years{font-size: 12px; opacity: .75; margin-top:4px;}
      .mini-tap{font-size: 11px; opacity: .60; margin-top:6px;}

      /* por defecto ocultamos edición */
      .role, .photo-actions, .fields, .footer, .kids{display:none;}
      .person.expanded .role,
      .person.expanded .photo-actions,
      .person.expanded .fields,
      .person.expanded .footer,
      .person.expanded .kids{display:block;}
      .person.expanded .photo-actions{display:flex;}
      .person.expanded .kids{display:flex;}
    }
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <h1>Árbol genealógico — <span class="brand">Familia Arango</span></h1>
      <div class="sub">
        Familia Arango, vamos a reconstruir juntos nuestro árbol genealógico, con algo de paciencia puedes editar nombres, fechas, fotos y agregar descendientes (hijos/nietos/bisnietos) desde cada tarjeta. Desde computador o celular, esta es una prueba piloto puede ser algo lenta, pero obtendremos un resultado bonito que vale la pena compartir, solo la familia tendrá el link en esta fase. Toca una foto para cambiarla. En celular, toca el nombre para editar (se abre la tarjeta).
        Los cambios se guardan en vivo para todos.
      </div>

      <div class="toolbar">
        <div class="pill" title="Estado de guardado">
          <span class="dot bad" id="connDot"></span>
          <span id="connText">Conectando…</span>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="container">

      <!-- Portada -->
      <section class="cover">
        <div class="cover-top">
          <div class="cover-imgwrap">
            <img id="coverImg" alt="Portada familiar" />
          </div>
          <div class="cover-side">
            <div>
              <h2>Portada familiar</h2>
              <p>Foto general (por ejemplo: los 11 Arango Originales).</p>
            </div>
            <div class="cover-actions">
              <!-- label nativo: funciona mejor en móvil -->
              <label class="btn btn-primary" for="filePicker" id="coverPickLabel">Cambiar portada</label>
              <button class="btn btn-danger" id="coverClearBtn" type="button">Quitar portada</button>
            </div>
          </div>
        </div>
        <div class="strip" id="first11Strip"></div>
      </section>

      <div class="divider"></div>

      <section class="gen" id="parentsGen" aria-label="Padres"></section>
      <div class="divider"></div>
      <section class="gen" id="childrenGen" aria-label="Hijos"></section>
    </div>
  </main>

  <!-- Un solo filePicker para TODO (portada y personas). Sin capture: permite galería -->
  <input type="file" id="filePicker" accept="image/*"
         style="position:fixed; left:-9999px; top:-9999px; width:1px; height:1px; opacity:0;" />

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.94.1/+esm";

    // ================== CONFIG EMBEBIDA (nadie tiene que pegar nada) ==================
    const DEFAULT_CFG = {
      url: "https://rgsgdycllmixpdoivize.supabase.co",
  key: "sb_publishable__opz94nN9f8XFTmprITCCw_FWBB5Muu",
      treeId: "familia-arango",
      bucket: "family-photos"
    };
    // IMPORTANTE: pega la key COMPLETA tal como sale en Supabase.

    // ================== UI refs ==================
    const connDot  = document.getElementById("connDot");
    const connText = document.getElementById("connText");

    const parentsGen  = document.getElementById("parentsGen");
    const childrenGen = document.getElementById("childrenGen");

    const coverImg = document.getElementById("coverImg");
    const coverPickLabel = document.getElementById("coverPickLabel");
    const coverClearBtn  = document.getElementById("coverClearBtn");
    const first11Strip   = document.getElementById("first11Strip");

    const filePicker = document.getElementById("filePicker");

    // ================== Supabase / Estado ==================
    let supabase = null;
    let TREE_ID = DEFAULT_CFG.treeId;
    let BUCKET  = DEFAULT_CFG.bucket;

    let savingTimer = null;
    let applyingRemote = false;
    let channel = null;

    // Target uploads: { type:"cover" } o { type:"person", id }
    let pendingPhotoTarget = null;

    function setConn(ok, text){
      connDot.className = "dot " + (ok ? "ok" : "bad");
      connText.textContent = text;
    }

    // ================== Placeholders ==================
    const placeholderImg = (() => {
      const svg =
        `<svg xmlns="http://www.w3.org/2000/svg" width="300" height="300">
          <defs>
            <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0" stop-color="#e2c77c" stop-opacity="0.60"/>
              <stop offset="1" stop-color="#c6a24a" stop-opacity="0.25"/>
            </linearGradient>
          </defs>
          <rect width="100%" height="100%" fill="#f6efe3"/>
          <rect x="22" y="22" width="256" height="256" rx="26" fill="url(#g)" stroke="rgba(0,0,0,0.14)"/>
          <circle cx="150" cy="135" r="42" fill="rgba(0,0,0,0.10)"/>
          <rect x="88" y="190" width="124" height="58" rx="29" fill="rgba(0,0,0,0.10)"/>
          <text x="150" y="52" text-anchor="middle" font-size="16" fill="rgba(0,0,0,0.45)" font-family="Arial">Foto</text>
        </svg>`;
      return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
    })();

    const placeholderCover = (() => {
      const svg =
        `<svg xmlns="http://www.w3.org/2000/svg" width="1400" height="700">
          <defs>
            <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0" stop-color="#f6efe3"/>
              <stop offset="1" stop-color="#e2c77c" stop-opacity="0.65"/>
            </linearGradient>
          </defs>
          <rect width="100%" height="100%" fill="url(#g)"/>
          <text x="50%" y="48%" text-anchor="middle" font-size="44" fill="rgba(0,0,0,0.35)" font-family="Arial">Portada familiar</text>
          <text x="50%" y="56%" text-anchor="middle" font-size="22" fill="rgba(0,0,0,0.28)" font-family="Arial">Foto general</text>
        </svg>`;
      return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
    })();

    // ================== Helpers ==================
    function escapeHtml(str) {
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function escapeAttr(str) { return escapeHtml(str).replaceAll("\n"," "); }
    function yearRange(birth, death){
      const y = (d) => (d && String(d).length >= 4 ? String(d).slice(0,4) : "");
      const b = y(birth), dth = y(death);
      if (b && dth) return `${b}–${dth}`;
      if (b && !dth) return `${b}–`;
      if (!b && dth) return `–${dth}`;
      return "";
    }
    function makeId(prefix="n"){
      if (crypto?.randomUUID) return `${prefix}_${crypto.randomUUID()}`;
      return `${prefix}_${Date.now()}_${Math.random().toString(16).slice(2)}`;
    }
    function makePerson({ role="", id=null } = {}){
      return {
        id: id || makeId("p"),
        role,
        name:"",
        birth:"",
        death:"",
        photo_url: placeholderImg,
        photo_path:"",
        children:[]
      };
    }

    // ================== Estado inicial ==================
    const defaultState = {
      familyName: "Arango",
      cover_photo_url: placeholderCover,
      cover_photo_path: "",
      parents: [
        { ...makePerson({ id:"p1", role:"Padre" }) },
        { ...makePerson({ id:"p2", role:"Madre" }) },
      ],
      children: Array.from({ length: 11 }, (_, i) => makePerson({ id:`c${i+1}`, role:`Hijo/a ${i+1}` }))
    };

    let state = structuredClone(defaultState);

    function normalizeNode(node){
      if (!node) return;
      if (!Array.isArray(node.children)) node.children = [];
      if (!node.photo_url) node.photo_url = placeholderImg;
      if (node.photo_url === "") node.photo_url = placeholderImg;
      node.children.forEach(normalizeNode);
    }
    function normalizeState(s){
      if (!s) return structuredClone(defaultState);
      if (!Array.isArray(s.parents) || s.parents.length < 2) s.parents = structuredClone(defaultState.parents);
      if (!Array.isArray(s.children)) s.children = [];
      s.parents.forEach(normalizeNode);
      s.children.forEach(normalizeNode);

      if (!s.cover_photo_url) s.cover_photo_url = placeholderCover;
      if (s.cover_photo_url === "") s.cover_photo_url = placeholderCover;
      if (!("cover_photo_path" in s)) s.cover_photo_path = "";

      return s;
    }

    // ================== Focus fix (para que no “salte” al escribir) ==================
    function captureFocus(){
      const el = document.activeElement;
      if (!(el instanceof HTMLInputElement)) return null;
      const card = el.closest(".person");
      if (!card) return null;
      return {
        id: card.dataset.id || null,
        field: el.dataset.field || null,
        start: el.selectionStart ?? 0,
        end: el.selectionEnd ?? 0
      };
    }
    function restoreFocus(f){
      if (!f?.id || !f?.field) return;
      const q = `.person[data-id="${CSS.escape(f.id)}"] input[data-field="${CSS.escape(f.field)}"]`;
      const input = document.querySelector(q);
      if (!(input instanceof HTMLInputElement)) return;
      input.focus({ preventScroll:true });
      try { input.setSelectionRange(f.start, f.end); } catch {}
    }

    // ================== Render ==================
    function renderCover(){
      coverImg.src = state.cover_photo_url || placeholderCover;

      first11Strip.innerHTML = "";
      const first11 = (state.children || []).slice(0, 11);
      first11.forEach((p, idx) => {
        const chip = document.createElement("div");
        chip.className = "sib";
        const img = document.createElement("img");
        img.src = p.photo_url || placeholderImg;
        img.alt = `Hijo ${idx+1}`;
        const name = document.createElement("span");
        name.textContent = (p.name && p.name.trim()) ? p.name.trim() : `Hijo ${idx+1}`;
        chip.appendChild(img);
        chip.appendChild(name);
        first11Strip.appendChild(chip);
      });
    }

    function personCard(node, { removable=false, compact=false } = {}) {
      const el = document.createElement("article");
      el.className = "person" + (compact ? " sub" : "");
      el.dataset.id = node.id;

      const imgSrc = node.photo_url || placeholderImg;
      const miniName = (node.name && node.name.trim()) ? node.name.trim() : "Sin nombre";
      const miniYears = yearRange(node.birth, node.death);

      el.innerHTML = `
        <div class="role">
          <b>${escapeHtml(node.role || "")}</b>
          ${removable ? `<button class="smallbtn remove" data-action="remove" type="button">Eliminar</button>` : `<span></span>`}
        </div>

        <div class="row">
          <!-- Foto: tocar abre selector (label nativo) -->
          <label class="avatar" for="filePicker" data-action="photo" title="Toca para cambiar la foto">
            <img alt="Foto" src="${imgSrc}">
          </label>

          <div class="photo-actions">
            <button class="smallbtn addkid" data-action="addChild" type="button">+ Agregar hijo/a</button>
            <button class="smallbtn" data-action="clearPhoto" type="button">Quitar foto</button>
          </div>
        </div>

        <div class="mini" data-action="toggle">
          <div class="mini-name">${escapeHtml(miniName)}</div>
          <div class="mini-years">${escapeHtml(miniYears)}</div>
          <div class="mini-tap">Toca aquí para editar</div>
        </div>

        <div class="fields">
          <label>Nombre
            <input type="text" data-field="name" placeholder="Escribe el nombre" value="${escapeAttr(node.name || "")}">
          </label>
          <label>Nacimiento
            <input type="date" data-field="birth" value="${escapeAttr(node.birth || "")}">
          </label>
          <label>Fallecimiento (opcional)
            <input type="date" data-field="death" value="${escapeAttr(node.death || "")}">
          </label>
          <label>Cariñosamente
            <input type="text" data-field="role" placeholder="Apodo en casa" value="${escapeAttr(node.role || "")}">
          </label>
        </div>

        <div class="footer">
          <span>${escapeHtml(node.id)}</span>
          <span>Familia Arango</span>
        </div>
      `;

      // ✅ Antes de que abra el selector, guardamos a quién le toca la foto
      el.addEventListener("pointerdown", (e) => {
        const lab = e.target.closest('label[data-action="photo"]');
        if (!lab) return;
        const ownerCard = lab.closest(".person");
        if (ownerCard !== el) return;

        pendingPhotoTarget = { type:"person", id: node.id };
        filePicker.value = "";
      });

      // ✅ Móvil: tocar mini abre/cierra edición
      el.addEventListener("click", (e) => {
        const isMobile = window.matchMedia("(max-width: 560px)").matches;

        const mini = e.target.closest('.mini[data-action="toggle"]');
        if (isMobile && mini) {
          const ownerCard = mini.closest(".person");
          if (ownerCard !== el) return;
          el.classList.toggle("expanded");
          return;
        }

        const actionEl = e.target.closest("button");
        if (!actionEl) return;

        const ownerCard = actionEl.closest(".person");
        if (ownerCard !== el) return;

        const action = actionEl.dataset.action;
        if (!action) return;

        if (action === "clearPhoto") {
          patchNode(node.id, { photo_url: placeholderImg, photo_path: "" });
          scheduleSave();
          return;
        }
        if (action === "addChild") {
          addChildTo(node.id);
          return;
        }
        if (action === "remove") {
          removeNode(node.id);
          return;
        }
      });

      // ✅ FIX: evita que inputs de nietos/bisnietos actualicen al padre (bubbling)
      el.addEventListener("input", (e) => {
        const input = e.target;
        if (!(input instanceof HTMLInputElement)) return;

        const ownerCard = input.closest(".person");
        if (ownerCard !== el) return;

        const field = input.dataset.field;
        if (!field) return;

        patchNode(node.id, { [field]: input.value });
      });

      // Descendientes
      if (Array.isArray(node.children) && node.children.length > 0) {
        const kids = document.createElement("div");
        kids.className = "kids";
        node.children.forEach(child => {
          const wrap = document.createElement("div");
          wrap.className = "kidwrap";
          wrap.appendChild(renderNode(child, { levelCompact:true }));
          kids.appendChild(wrap);
        });
        el.appendChild(kids);
      }

      return el;
    }

    function renderNode(node, { levelCompact=false } = {}) {
      return personCard(node, { removable:true, compact: levelCompact });
    }

    function renderAll(){
      const f = captureFocus();

      renderCover();
      parentsGen.innerHTML = "";
      childrenGen.innerHTML = "";

      state.parents.forEach(p => parentsGen.appendChild(personCard(p, { removable:false, compact:false })));
      state.children.forEach(c => childrenGen.appendChild(renderNode(c, { levelCompact:false })));

      restoreFocus(f);
    }

    // ================== Buscar / actualizar ==================
    function findInChildren(parentNode, id){
      if (!parentNode?.children?.length) return null;
      for (const child of parentNode.children) {
        if (child.id === id) return { node:child, parent: parentNode, parentChildrenArray: parentNode.children };
        const deeper = findInChildren(child, id);
        if (deeper) return deeper;
      }
      return null;
    }

    function findNodeById(id){
      for (const p of state.parents) {
        if (p.id === id) return { node:p, parent:null, parentChildrenArray:null };
        const hit = findInChildren(p, id);
        if (hit) return hit;
      }
      for (const c of state.children) {
        if (c.id === id) return { node:c, parent:null, parentChildrenArray: state.children };
        const hit = findInChildren(c, id);
        if (hit) return hit;
      }
      return null;
    }

    function patchNode(id, patch){
      const hit = findNodeById(id);
      if (!hit?.node) return;
      Object.assign(hit.node, patch);
      renderAll();
      scheduleSave();
    }

    function addChildTo(parentId){
      const hit = findNodeById(parentId);
      if (!hit?.node) return;

      const parent = hit.node;
      if (!Array.isArray(parent.children)) parent.children = [];

      const nextIndex = parent.children.length + 1;
      const child = makePerson({ role: `Hijo/a ${nextIndex}` });
      parent.children.push(child);

      renderAll();
      scheduleSave();
    }

    function removeNode(id){
      // Bloquear borrar padres y los 11 hijos raíz (para evitar accidentes)
      if (id === "p1" || id === "p2") return alert("No se pueden eliminar los padres.");
      if (/^c([1-9]|10|11)$/.test(id)) return alert("Estos 11 hijos no se eliminan (solo edita nombre/foto).");

      const hit = findNodeById(id);
      if (!hit?.parentChildrenArray) return;

      const idx = hit.parentChildrenArray.findIndex(x => x.id === id);
      if (idx >= 0) {
        hit.parentChildrenArray.splice(idx, 1);
        renderAll();
        scheduleSave();
      }
    }

    // ================== Portada ==================
    coverPickLabel.addEventListener("pointerdown", () => {
      pendingPhotoTarget = { type:"cover" };
      filePicker.value = "";
    });

    coverClearBtn.addEventListener("click", () => {
      state.cover_photo_url = placeholderCover;
      state.cover_photo_path = "";
      renderAll();
      scheduleSave();
    });

    // ================== Subir fotos (personas / portada) ==================
    filePicker.addEventListener("change", async () => {
      const file = filePicker.files?.[0];
      if (!file || !pendingPhotoTarget) return;
      if (!supabase) return alert("No hay conexión con Supabase (revisa URL/Key en el código).");

      try {
        const maxSide = (pendingPhotoTarget.type === "cover") ? 1400 : 900;
        const jpgBlob = await compressImageToJpeg(file, maxSide, 0.85);

        const ts = Date.now();
        const path = (pendingPhotoTarget.type === "cover")
          ? `${TREE_ID}/cover_${ts}.jpg`
          : `${TREE_ID}/${pendingPhotoTarget.id}_${ts}.jpg`;

        const { error: upErr } = await supabase.storage
          .from(BUCKET)
          .upload(path, jpgBlob, { contentType: "image/jpeg" });
        if (upErr) throw upErr;

        const { data: pub } = supabase.storage.from(BUCKET).getPublicUrl(path);
        const publicUrl = pub?.publicUrl || placeholderImg;

        if (pendingPhotoTarget.type === "cover") {
          state.cover_photo_url = publicUrl;
          state.cover_photo_path = path;
          renderAll();
          scheduleSave();
        } else {
          patchNode(pendingPhotoTarget.id, { photo_url: publicUrl, photo_path: path });
        }

        pendingPhotoTarget = null;
      } catch (e) {
        console.error(e);
        alert("No se pudo subir la foto. Revisa bucket/policies (insert/select) y que el bucket sea público.");
      }
    });

    async function compressImageToJpeg(file, maxSide=900, quality=0.85){
      const img = await fileToImage(file);
      const { w, h } = fitBox(img.width, img.height, maxSide);
      const canvas = document.createElement("canvas");
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, w, h);
      return await new Promise((resolve) => canvas.toBlob(resolve, "image/jpeg", quality));
    }
    function fitBox(w, h, maxSide){
      const scale = Math.min(1, maxSide / Math.max(w,h));
      return { w: Math.round(w*scale), h: Math.round(h*scale) };
    }
    function fileToImage(file){
      return new Promise((resolve, reject) => {
        const url = URL.createObjectURL(file);
        const img = new Image();
        img.onload = () => { URL.revokeObjectURL(url); resolve(img); };
        img.onerror = reject;
        img.src = url;
      });
    }

    // ================== Guardado (debounce) ==================
    function scheduleSave(){
      if (!supabase) return;
      if (applyingRemote) return;
      clearTimeout(savingTimer);
      savingTimer = setTimeout(saveRemote, 650);
    }

    async function saveRemote(){
      if (!supabase) return;
      if (applyingRemote) return;

      const payload = {
        id: TREE_ID,
        data: state,
        updated_at: new Date().toISOString()
      };

      const { error } = await supabase
        .from("family_trees")
        .upsert(payload, { onConflict: "id" });

      if (error) {
        console.error(error);
        setConn(false, "Error guardando");
      } else {
        setConn(true, "Guardado en vivo");
      }
    }

    async function ensureRow(){
      const { data, error } = await supabase
        .from("family_trees")
        .select("data")
        .eq("id", TREE_ID)
        .maybeSingle();

      if (error) {
        console.error(error);
        setConn(false, "No puedo leer (RLS)");
        return;
      }

      if (!data) {
        const { error: insErr } = await supabase
          .from("family_trees")
          .insert({ id: TREE_ID, data: defaultState });

        if (insErr) {
          console.error(insErr);
          setConn(false, "No puedo crear (RLS)");
          return;
        }
        state = structuredClone(defaultState);
      } else {
        state = normalizeState(data.data || structuredClone(defaultState));
      }

      renderAll();
      setConn(true, "Conectado");
    }

    function subscribeRealtime(){
      if (channel) {
        try { supabase.removeChannel(channel); } catch {}
      }

      channel = supabase
        .channel(`tree:${TREE_ID}`)
        .on(
          "postgres_changes",
          { event:"*", schema:"public", table:"family_trees", filter:`id=eq.${TREE_ID}` },
          (payload) => {
            const newData = payload?.new?.data;
            if (!newData) return;

            applyingRemote = true;
            state = normalizeState(newData);
            renderAll();
            applyingRemote = false;

            setConn(true, "Actualizado en vivo");
          }
        )
        .subscribe();
    }

    // ================== Boot ==================
    async function boot(){
      TREE_ID = DEFAULT_CFG.treeId;
      BUCKET  = DEFAULT_CFG.bucket;

      supabase = createClient(DEFAULT_CFG.url, DEFAULT_CFG.key);

      setConn(true, "Conectando…");
      await ensureRow();
      subscribeRealtime();
    }

    // Init
    state = normalizeState(state);
    renderAll();
    await boot();
  </script>
</body>
</html>

